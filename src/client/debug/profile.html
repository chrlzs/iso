<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Performance Profiler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin-top: 0;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .checkbox-group {
            margin-bottom: 5px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: none;
        }
        
        .results h2 {
            margin-top: 0;
            color: #333;
        }
        
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Game Performance Profiler</h1>
        
        <div class="form-group">
            <label for="duration">Duration (seconds):</label>
            <input type="number" id="duration" value="30" min="5" max="300">
        </div>
        
        <div class="form-group">
            <label for="entityCount">Test Entities:</label>
            <input type="number" id="entityCount" value="50" min="0" max="500">
        </div>
        
        <div class="form-group">
            <label for="movementPattern">Movement Pattern:</label>
            <select id="movementPattern">
                <option value="random">Random</option>
                <option value="circle">Circle</option>
                <option value="zigzag">Zigzag</option>
                <option value="none">None</option>
            </select>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="runWithPerformanceMode" checked>
            <label for="runWithPerformanceMode" style="display: inline;">Run with Performance Mode</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="runWithoutPerformanceMode" checked>
            <label for="runWithoutPerformanceMode" style="display: inline;">Run without Performance Mode</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="captureFrameTimes" checked>
            <label for="captureFrameTimes" style="display: inline;">Capture Frame Times</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="spawnEntities" checked>
            <label for="spawnEntities" style="display: inline;">Spawn Test Entities</label>
        </div>
        
        <button id="startProfile">Start Profiling</button>
        
        <div id="results" class="results">
            <h2>Profile Results</h2>
            <div id="resultsContent"></div>
            
            <div class="chart-container">
                <canvas id="fpsChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="frameTimeChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { runGameProfile } from './GameProfiler.js';
        
        document.getElementById('startProfile').addEventListener('click', async () => {
            // Get form values
            const duration = parseInt(document.getElementById('duration').value);
            const entityCount = parseInt(document.getElementById('entityCount').value);
            const movementPattern = document.getElementById('movementPattern').value;
            const runWithPerformanceMode = document.getElementById('runWithPerformanceMode').checked;
            const runWithoutPerformanceMode = document.getElementById('runWithoutPerformanceMode').checked;
            const captureFrameTimes = document.getElementById('captureFrameTimes').checked;
            const spawnEntities = document.getElementById('spawnEntities').checked;
            
            // Disable button during profiling
            const button = document.getElementById('startProfile');
            button.disabled = true;
            button.textContent = 'Profiling...';
            
            try {
                // Get game instance from parent window
                const gameInstance = window.opener.gameInstance;
                
                if (!gameInstance) {
                    alert('Game instance not found. Make sure the game is running.');
                    return;
                }
                
                // Run profile
                const results = await runGameProfile(gameInstance, {
                    duration,
                    entityCount,
                    movementPattern,
                    runWithPerformanceMode,
                    runWithoutPerformanceMode,
                    captureFrameTimes,
                    spawnEntities
                });
                
                // Display results
                displayResults(results);
                
                // Show results section
                document.getElementById('results').style.display = 'block';
            } catch (error) {
                console.error('Error running profile:', error);
                alert(`Error running profile: ${error.message}`);
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Start Profiling';
            }
        });
        
        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');
            
            // Create summary table
            let html = '<h3>Summary</h3>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Metric</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Value</th></tr>';
            
            const summary = results.summary;
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Average FPS</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.avgFPS.toFixed(1)}</td></tr>`;
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Min FPS</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.minFPS.toFixed(1)}</td></tr>`;
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Max FPS</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.maxFPS.toFixed(1)}</td></tr>`;
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">FPS Stability</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.fpsStability.toFixed(2)}</td></tr>`;
            
            if (summary.memoryGrowth !== undefined) {
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Memory Growth</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.memoryGrowth.toFixed(2)} MB</td></tr>`;
            }
            
            if (summary.frameTimeAvg !== undefined) {
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Avg Frame Time</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.frameTimeAvg.toFixed(2)} ms</td></tr>`;
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">95th Percentile</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${summary.frameTime95.toFixed(2)} ms</td></tr>`;
            }
            
            html += '</table>';
            
            // Add individual profiles
            results.profiles.forEach(profile => {
                html += `<h3>${profile.mode}</h3>`;
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Metric</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Value</th></tr>';
                
                const data = profile.results;
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">FPS</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.fps.average.toFixed(1)} (${data.fps.min.toFixed(1)}-${data.fps.max.toFixed(1)})</td></tr>`;
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">FPS Stability</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.fps.stdDev.toFixed(2)}</td></tr>`;
                
                if (data.memory) {
                    html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Memory Growth</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${(data.memory.growth / (1024 * 1024)).toFixed(2)} MB</td></tr>`;
                }
                
                if (data.frameTimes) {
                    html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Frame Time</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.frameTimes.average.toFixed(2)} ms (${data.frameTimes.min.toFixed(2)}-${data.frameTimes.max.toFixed(2)} ms)</td></tr>`;
                    html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Median Frame Time</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.frameTimes.median.toFixed(2)} ms</td></tr>`;
                    html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">95th Percentile</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.frameTimes.percentile95.toFixed(2)} ms</td></tr>`;
                    html += `<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">99th Percentile</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">${data.frameTimes.percentile99.toFixed(2)} ms</td></tr>`;
                }
                
                html += '</table>';
            });
            
            resultsContent.innerHTML = html;
            
            // Create charts if Chart.js is available
            if (window.Chart) {
                createCharts(results);
            } else {
                // Load Chart.js dynamically
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = () => createCharts(results);
                document.head.appendChild(script);
            }
        }
        
        function createCharts(results) {
            // Create FPS chart
            const fpsCtx = document.getElementById('fpsChart').getContext('2d');
            const fpsData = {
                labels: [],
                datasets: []
            };
            
            // Create frame time chart
            const frameTimeCtx = document.getElementById('frameTimeChart').getContext('2d');
            const frameTimeData = {
                labels: [],
                datasets: []
            };
            
            // Create memory chart
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            const memoryData = {
                labels: [],
                datasets: []
            };
            
            // Colors for different profiles
            const colors = ['#4CAF50', '#2196F3', '#FF5722', '#9C27B0'];
            
            // Add data for each profile
            results.profiles.forEach((profile, index) => {
                const data = profile.results;
                const color = colors[index % colors.length];
                
                // Add FPS data
                if (data.samples && data.samples.length > 0) {
                    const fpsSamples = data.samples.map(s => s.fps);
                    const timestamps = data.samples.map(s => s.elapsedTime / 1000); // Convert to seconds
                    
                    fpsData.datasets.push({
                        label: `${profile.mode} FPS`,
                        data: fpsSamples,
                        borderColor: color,
                        backgroundColor: `${color}33`,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    });
                    
                    // Use the same timestamps for all charts
                    if (fpsData.labels.length === 0) {
                        fpsData.labels = timestamps;
                    }
                    
                    // Add memory data if available
                    if (data.samples[0].memory) {
                        const memorySamples = data.samples.map(s => s.memory.usedJSHeapSize / (1024 * 1024)); // Convert to MB
                        
                        memoryData.datasets.push({
                            label: `${profile.mode} Memory (MB)`,
                            data: memorySamples,
                            borderColor: color,
                            backgroundColor: `${color}33`,
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        });
                        
                        if (memoryData.labels.length === 0) {
                            memoryData.labels = timestamps;
                        }
                    }
                }
                
                // Add frame time data if available
                if (data.frameTimes && data.frameTimes.raw) {
                    // Use a subset of frame times to avoid overwhelming the chart
                    const frameTimeSamples = data.frameTimes.raw;
                    const frameTimeCount = frameTimeSamples.length;
                    const maxPoints = 100;
                    const step = Math.max(1, Math.floor(frameTimeCount / maxPoints));
                    
                    const sampledFrameTimes = [];
                    for (let i = 0; i < frameTimeCount; i += step) {
                        sampledFrameTimes.push(frameTimeSamples[i]);
                    }
                    
                    frameTimeData.datasets.push({
                        label: `${profile.mode} Frame Time (ms)`,
                        data: sampledFrameTimes,
                        borderColor: color,
                        backgroundColor: `${color}33`,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    });
                    
                    if (frameTimeData.labels.length === 0) {
                        frameTimeData.labels = Array.from({ length: sampledFrameTimes.length }, (_, i) => i);
                    }
                }
            });
            
            // Create charts
            new Chart(fpsCtx, {
                type: 'line',
                data: fpsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'FPS over Time'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'FPS'
                            },
                            min: 0
                        }
                    }
                }
            });
            
            new Chart(frameTimeCtx, {
                type: 'line',
                data: frameTimeData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Frame Time'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Frame'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Time (ms)'
                            },
                            min: 0
                        }
                    }
                }
            });
            
            new Chart(memoryCtx, {
                type: 'line',
                data: memoryData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Memory Usage'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Memory (MB)'
                            },
                            min: 0
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
